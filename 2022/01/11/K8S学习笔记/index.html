<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="k8s学习记录">
<meta property="og:type" content="article">
<meta property="og:title" content="K8S学习笔记">
<meta property="og:url" content="http://example.com/2022/01/11/K8S%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="黄焖叽米饭的狗屋">
<meta property="og:description" content="k8s学习记录">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2022/01/11/K8S%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/container.png">
<meta property="og:image" content="http://example.com/2022/01/11/K8S%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/components-of-kubernetes.svg">
<meta property="article:published_time" content="2022-01-11T11:27:39.000Z">
<meta property="article:modified_time" content="2022-03-29T16:42:22.095Z">
<meta property="article:author" content="Doge Rice">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/01/11/K8S%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/container.png">


<link rel="canonical" href="http://example.com/2022/01/11/K8S%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2022/01/11/K8S%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/","path":"2022/01/11/K8S学习笔记/","title":"K8S学习笔记"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>K8S学习笔记 | 黄焖叽米饭的狗屋</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">黄焖叽米饭的狗屋</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#k8s%E7%B3%BB%E7%BB%9F%E7%BB%84%E4%BB%B6"><span class="nav-number">1.</span> <span class="nav-text">k8s系统组件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2%E7%BB%84%E4%BB%B6"><span class="nav-number">1.1.</span> <span class="nav-text">控制平面组件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Node%E7%BB%84%E4%BB%B6"><span class="nav-number">1.2.</span> <span class="nav-text">Node组件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">2.</span> <span class="nav-text">核心概念</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7kubectl"><span class="nav-number">3.</span> <span class="nav-text">命令行工具kubectl</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E7%BC%96%E6%8E%92yaml"><span class="nav-number">4.</span> <span class="nav-text">资源编排yaml</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B"><span class="nav-number">5.</span> <span class="nav-text">常见资源类型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Pod"><span class="nav-number">5.1.</span> <span class="nav-text">Pod</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">5.1.1.</span> <span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pod%E5%AD%98%E5%9C%A8%E6%84%8F%E4%B9%89"><span class="nav-number">5.1.2.</span> <span class="nav-text">pod存在意义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pod%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6"><span class="nav-number">5.1.3.</span> <span class="nav-text">pod实现机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E6%8B%89%E5%8F%96%E7%AD%96%E7%95%A5"><span class="nav-number">5.1.4.</span> <span class="nav-text">镜像拉取策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6"><span class="nav-number">5.1.5.</span> <span class="nav-text">资源限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pod%E9%87%8D%E5%90%AF%E6%9C%BA%E5%88%B6"><span class="nav-number">5.1.6.</span> <span class="nav-text">Pod重启机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pod%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="nav-number">5.1.7.</span> <span class="nav-text">Pod健康检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pod%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5"><span class="nav-number">5.1.8.</span> <span class="nav-text">Pod调度策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BD%B1%E5%93%8D%E8%B0%83%E5%BA%A6%E7%9A%84%E5%9B%A0%E7%B4%A0"><span class="nav-number">5.1.9.</span> <span class="nav-text">影响调度的因素</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Controller-deployment"><span class="nav-number">5.2.</span> <span class="nav-text">Controller(deployment)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-1"><span class="nav-number">5.2.1.</span> <span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#deployment%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E5%BA%94%E7%94%A8"><span class="nav-number">5.2.2.</span> <span class="nav-text">deployment控制器的应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8deployment%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8-yaml"><span class="nav-number">5.2.3.</span> <span class="nav-text">使用deployment部署应用(yaml)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%8D%87%E7%BA%A7%E5%9B%9E%E6%BB%9A%E5%92%8C%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9"><span class="nav-number">5.2.4.</span> <span class="nav-text">应用升级回滚和弹性伸缩</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Service"><span class="nav-number">5.3.</span> <span class="nav-text">Service</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#service%E6%84%8F%E4%B9%89"><span class="nav-number">5.3.1.</span> <span class="nav-text">service意义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pod%E4%B8%8EService%E5%85%B3%E7%B3%BB"><span class="nav-number">5.3.2.</span> <span class="nav-text">Pod与Service关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8service%E7%B1%BB%E5%9E%8B"><span class="nav-number">5.3.3.</span> <span class="nav-text">常用service类型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Controller-StatefulSet%E3%80%81DaemonSet%E3%80%81Job%E3%80%81cronJob"><span class="nav-number">5.4.</span> <span class="nav-text">Controller(StatefulSet、DaemonSet、Job、cronJob)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A0%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8%EF%BC%9A"><span class="nav-number">5.4.1.</span> <span class="nav-text">无状态应用：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8%EF%BC%9A"><span class="nav-number">5.4.2.</span> <span class="nav-text">有状态应用：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E6%9C%89%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8StatefulSet"><span class="nav-number">5.4.3.</span> <span class="nav-text">部署有状态应用StatefulSet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8BDaemonSet"><span class="nav-number">5.4.4.</span> <span class="nav-text">部署守护进程DaemonSet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Job%E4%B8%80%E6%AC%A1%E6%80%A7%E4%BB%BB%E5%8A%A1"><span class="nav-number">5.4.5.</span> <span class="nav-text">Job一次性任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CronJob%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="nav-number">5.4.6.</span> <span class="nav-text">CronJob定时任务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86-Secret"><span class="nav-number">5.5.</span> <span class="nav-text">配置管理(Secret)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86-ConfigMap"><span class="nav-number">5.6.</span> <span class="nav-text">配置管理(ConfigMap)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#k8s%E9%9B%86%E7%BE%A4%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6"><span class="nav-number">6.</span> <span class="nav-text">k8s集群安全机制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">6.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RBAC-%E5%9F%BA%E4%BA%8E%E8%A7%92%E8%89%B2%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="nav-number">6.2.</span> <span class="nav-text">RBAC 基于角色的访问控制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ingress"><span class="nav-number">7.</span> <span class="nav-text">Ingress</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85ingress-controller"><span class="nav-number">7.1.</span> <span class="nav-text">安装ingress controller</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEingress"><span class="nav-number">7.2.</span> <span class="nav-text">配置ingress</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Helm"><span class="nav-number">8.</span> <span class="nav-text">Helm</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#helm%E5%AE%89%E8%A3%85"><span class="nav-number">8.1.</span> <span class="nav-text">helm安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#helm%E9%85%8D%E7%BD%AE%E4%BB%93%E5%BA%93"><span class="nav-number">8.2.</span> <span class="nav-text">helm配置仓库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8helm%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8"><span class="nav-number">8.3.</span> <span class="nav-text">使用helm快速部署应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89chart"><span class="nav-number">8.4.</span> <span class="nav-text">自定义chart</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0yaml%E9%AB%98%E6%95%88%E5%A4%8D%E7%94%A8"><span class="nav-number">8.5.</span> <span class="nav-text">实现yaml高效复用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8"><span class="nav-number">9.</span> <span class="nav-text">持久化存储</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#nfs%EF%BC%9A%E7%BD%91%E7%BB%9C%E5%AD%98%E5%82%A8"><span class="nav-number">9.1.</span> <span class="nav-text">nfs：网络存储</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pv%E4%B8%8Epvc"><span class="nav-number">9.2.</span> <span class="nav-text">pv与pvc</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7"><span class="nav-number">10.</span> <span class="nav-text">集群资源监控</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85kubesphere"><span class="nav-number">10.1.</span> <span class="nav-text">安装kubesphere</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85dashboard"><span class="nav-number">10.2.</span> <span class="nav-text">安装dashboard</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Doge Rice</p>
  <div class="site-description" itemprop="description">黄焖叽米饭的狗屋</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/11/K8S%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Doge Rice">
      <meta itemprop="description" content="黄焖叽米饭的狗屋">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄焖叽米饭的狗屋">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          K8S学习笔记
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-01-11 19:27:39" itemprop="dateCreated datePublished" datetime="2022-01-11T19:27:39+08:00">2022-01-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-03-30 00:42:22" itemprop="dateModified" datetime="2022-03-30T00:42:22+08:00">2022-03-30</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description">k8s学习记录</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>传统服务模型与容器化服务模型</p>
<p><img src="/2022/01/11/K8S%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/container.png"></p>
<h1 id="k8s系统组件"><a href="#k8s系统组件" class="headerlink" title="k8s系统组件"></a>k8s系统组件</h1><p><img src="/2022/01/11/K8S%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/components-of-kubernetes.svg" alt="components-of-kubernetes"></p>
<h2 id="控制平面组件"><a href="#控制平面组件" class="headerlink" title="控制平面组件"></a>控制平面组件</h2><p>控制平面的组件对集群做出全局决策(比如调度)，以及检测和响应集群事件（例如，当不满足部署的 <code>replicas</code> 字段时，启动新的 pod）。</p>
<p><strong>ApiServer</strong></p>
<p>ApiServer负责对外提供RESTful的 Kubernetes API。是 Kubernetes 控制平面接收指令的入口。任何对资源进行增删改查的操作都要交给APIServer处理后再提交给etcd</p>
<p><strong>etcd</strong></p>
<p>etcd 是兼具一致性和高可用性的键值数据库，可以作为保存 Kubernetes 所有集群数据的后台数据库。</p>
<p><strong>scheduler</strong></p>
<p>负责调度pod到合适的Node上。调度决策考虑的因素包括单个 Pod 和 Pod 集合的资源需求、硬件/软件/策略约束、亲和性和反亲和性规范等。</p>
<p><strong>controller-manager</strong></p>
<p>用于在主节点上管理控制器的组件，每个资源一般都对应有一个控制器，这些控制器包括：</p>
<ul>
<li>节点控制器（Node Controller）: 负责在节点出现故障时进行通知和响应。</li>
<li>副本控制器（Replication Controller）: 负责为系统中的每个副本控制器对象维护正确数量的 Pod。</li>
<li>端点控制器（Endpoints Controller）: 填充端点(Endpoints)对象(即加入 Service 与 Pod)。</li>
<li>服务帐户和令牌控制器（Service Account &amp; Token Controllers）: 为新的命名空间创建默认帐户和 API 访问令牌.</li>
</ul>
<h2 id="Node组件"><a href="#Node组件" class="headerlink" title="Node组件"></a>Node组件</h2><p><strong>kubelet</strong></p>
<p>一个在集群中每个<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/architecture/nodes/">节点（node）</a>上运行的代理。 它保证<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/overview/what-is-kubernetes/#why-containers">容器（containers）</a>都 运行在 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Pod</a> 中。</p>
<p>kubelet 接收一组通过各类机制提供给它的 PodSpecs，确保这些 PodSpecs 中描述的容器处于运行状态且健康。 kubelet 只管理由 Kubernetes 创建的容器。</p>
<p><strong>kube-proxy</strong></p>
<p>是集群中每个节点上运行的网络代理， 用于实现 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/">服务（Service）</a> 。kube-proxy 维护节点上的网络规则。这些网络规则允许从集群内部或外部的网络会话与 Pod 进行网络通信。</p>
<p><strong>容器运行时(Container Runtime)</strong></p>
<p>Kubernetes 支持多个容器运行环境: <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubectl/docker-cli-to-kubectl/">Docker</a>、 <a target="_blank" rel="noopener" href="https://containerd.io/docs/">containerd</a>、<a target="_blank" rel="noopener" href="https://cri-o.io/#what-is-cri-o">CRI-O</a> 以及任何实现 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-node/container-runtime-interface.md">Kubernetes CRI (容器运行环境接口)</a>的容器环境。</p>
<h1 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h1><p><strong>master</strong></p>
<p>集群的控制节点，每个K8s集群里需要有一个Master节点来负责整个集群的管理和控制。基本上k8s的所有控制命令都发给它，它来负责整个具体的执行过程。Master节点通常占据一个独立的服务器（高可用部署建议3台服务器）。</p>
<p>Master节点运行着以下关键进程：</p>
<ul>
<li>API Server：集群控制的入口进程。</li>
<li>Controller Manager：K8s里所有资源对象的自动化控制中心</li>
<li>Scheduler:负责资源调度的进程。</li>
<li>etcd:分布式持久化，所有资源对象的数据全部保存在etcd。</li>
</ul>
<p><strong>node</strong></p>
<p>Node节点是K8s集群中的工作负载节点，当某个Node宕机，其上的工作负载会被Master自动转移到其他节点上。</p>
<p>Node节点运行着以下关键进程：</p>
<ul>
<li>kubelet: 负责Pod对应容器的创建、启停等任务。</li>
<li>kube-proxy: 实现k8s service的通信和负载均衡机制的重要组件。</li>
</ul>
<p><strong>pod</strong></p>
<ul>
<li>k8s集群中最小的部署单元</li>
<li>一组容器的集合</li>
<li>一个pod具有独立网络ip，</li>
<li>生命周期短暂，用完即焚 永久销毁</li>
</ul>
<p><strong>controller</strong></p>
<p>​        当定义了一个controller并提交到了K8s集群以后，Master上的Controller Manager组件就得到通知，定时巡检系统中目前存活的目标Pod,并且确保目标Pod实例的数量刚好等于此controller的期望值。如果有过多的副本在运行，系统就会停掉一些Pod,否则系统就会再自动创建一些Pod。controller有多种类型：deployment、statefulSet、DaemonSet、Job、CronJob等</p>
<ul>
<li>确保预期的pod副本数量</li>
<li>无状态应用部署，一般为deployment，相当于ReplicationController 的升级版</li>
<li>有状态应用部署，一般用statefulSet</li>
</ul>
<p><strong>service</strong></p>
<p>​        service定义一组pod的访问规则，可以看成一组Pod的对外访问接口。集群中的pod可以无障碍的访问service。service常见有以下三种类型，应对不同场景的服务开放</p>
<ul>
<li><p>ClusterIp模式：只对集群内部提供服务</p>
</li>
<li><p>Nodeport模式：在每个node上开放端口，对外提供服务</p>
</li>
<li><p>LoadBalance模式：负载均衡，一般配合云服务平台提供的负载均衡器使用</p>
</li>
</ul>
<h1 id="命令行工具kubectl"><a href="#命令行工具kubectl" class="headerlink" title="命令行工具kubectl"></a>命令行工具kubectl</h1><p><code>kubectl --help</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">Basic Commands (Beginner):</span><br><span class="line">  create         Create a resource from a file or from stdin.</span><br><span class="line">  expose         使用 replication controller, service, deployment 或者 pod 并暴露它作为一个 新的</span><br><span class="line">Kubernetes Service</span><br><span class="line">  run            在集群中运行一个指定的镜像</span><br><span class="line">  set            为 objects 设置一个指定的特征</span><br><span class="line"> </span><br><span class="line">Basic Commands (Intermediate):</span><br><span class="line">  explain        查看资源的文档</span><br><span class="line">  get            显示一个或更多 resources</span><br><span class="line">  edit           在服务器上编辑一个资源</span><br><span class="line">  delete         Delete resources by filenames, stdin, resources and names, or by resources and label selector</span><br><span class="line"> </span><br><span class="line">Deploy Commands:</span><br><span class="line">  rollout        Manage the rollout of a resource</span><br><span class="line">  scale          为 Deployment, ReplicaSet, Replication Controller 或者 Job 设置一个新的副本数量</span><br><span class="line">  autoscale      自动调整一个 Deployment, ReplicaSet, 或者 ReplicationController 的副本数量</span><br><span class="line"> </span><br><span class="line">Cluster Management Commands:</span><br><span class="line">  certificate    修改 certificate 资源.</span><br><span class="line">  cluster-info   显示集群信息</span><br><span class="line">  top            Display Resource (CPU/Memory/Storage) usage.</span><br><span class="line">  cordon         标记 node 为 unschedulable</span><br><span class="line">  uncordon       标记 node 为 schedulable</span><br><span class="line">  drain          Drain node in preparation for maintenance</span><br><span class="line">  taint          更新一个或者多个 node 上的 taints</span><br><span class="line"> </span><br><span class="line">Troubleshooting and Debugging Commands:</span><br><span class="line">  describe       显示一个指定 resource 或者 group 的 resources 详情</span><br><span class="line">  logs           输出容器在 pod 中的日志</span><br><span class="line">  attach         Attach 到一个运行中的 container</span><br><span class="line">  exec           在一个 container 中执行一个命令</span><br><span class="line">  port-forward   Forward one or more local ports to a pod</span><br><span class="line">  proxy          运行一个 proxy 到 Kubernetes API server</span><br><span class="line">  cp             复制 files 和 directories 到 containers 和从容器中复制 files 和 directories.</span><br><span class="line">  auth           Inspect authorization</span><br><span class="line"> </span><br><span class="line">Advanced Commands:</span><br><span class="line">  apply          通过文件名或标准输入流(stdin)对资源进行配置</span><br><span class="line">  patch          使用 strategic merge patch 更新一个资源的 field(s)</span><br><span class="line">  replace        通过 filename 或者 stdin替换一个资源</span><br><span class="line">  wait           Experimental: Wait for one condition on one or many resources</span><br><span class="line">  convert        在不同的 API versions 转换配置文件</span><br><span class="line"> </span><br><span class="line">Settings Commands:</span><br><span class="line">  label          更新在这个资源上的 labels</span><br><span class="line">  annotate       更新一个资源的注解</span><br><span class="line">  completion     Output shell completion code for the specified shell (bash or zsh)</span><br><span class="line"> </span><br><span class="line">Other Commands:</span><br><span class="line">  alpha          Commands for features in alpha</span><br><span class="line">  api-resources  Print the supported API resources on the server</span><br><span class="line">  api-versions   Print the supported API versions on the server, in the form of &quot;group/version&quot;</span><br><span class="line">  config         修改 kubeconfig 文件</span><br><span class="line">  plugin         Runs a command-line plugin</span><br><span class="line">  version        输出 client 和 server 的版本信息</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="资源编排yaml"><a href="#资源编排yaml" class="headerlink" title="资源编排yaml"></a>资源编排yaml</h1><p>每一个k8s对象都可用yaml文件进行描述，kubelet依据yaml内容创建对象</p>
<p>示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  replicas: 2 # tells deployment to run 2 pods matching the template</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.14.2</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>



<p>字段说明</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>apiVersion</td>
<td>API版本</td>
</tr>
<tr>
<td>kind</td>
<td>资源类型</td>
</tr>
<tr>
<td>metadata</td>
<td>资源元数据</td>
</tr>
<tr>
<td>spec</td>
<td>资源规格</td>
</tr>
<tr>
<td>replicas</td>
<td>副本数量</td>
</tr>
<tr>
<td>selector</td>
<td>标签选择器</td>
</tr>
<tr>
<td>template</td>
<td>pod模板</td>
</tr>
<tr>
<td>metadata</td>
<td>pod元数据</td>
</tr>
<tr>
<td>spec</td>
<td>pod规格</td>
</tr>
<tr>
<td>containers</td>
<td>容器配置</td>
</tr>
</tbody></table>
<p>快速生成yaml文件</p>
<ul>
<li><p>方式一：kubectl create 生成</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment web --image=nginx -o yaml --dry-run &gt;my1.yaml</span><br></pre></td></tr></table></figure>
</li>
<li><p>方式二：kubectl get 导出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deploy nginx -o yaml &gt; my2.yaml</span><br></pre></td></tr></table></figure>


</li>
</ul>
<p>集群中的每一个对象都有一个 <code>name</code> 来标识在同一 <code>namespace</code> 下同类资源中的唯一性。</p>
<p>每个k8s对象都有一个 <code>uid</code> 来标识在整个集群中的唯一性</p>
<p>对于用户提供的非唯一性的属性，Kubernetes 提供了 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/working-with-objects/labels">标签（Labels）</a>和 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/annotations/">注解（Annotation）</a>机制。</p>
<h1 id="常见资源类型"><a href="#常见资源类型" class="headerlink" title="常见资源类型"></a>常见资源类型</h1><h2 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><ul>
<li>k8s中最小的部署单元</li>
<li>包含多个容器（一组容器的集合）</li>
<li>一个pod中容器共享网络命名空间</li>
<li>pod是短暂的</li>
<li>每个pod有一个特殊的被称为“根容器”的Pause容器。Pause容器对应的镜像属于k8s平台的一部分，除了Pause容器，每个Pod还包含一个或多个紧密相关的用户业务容器</li>
</ul>
<h3 id="pod存在意义"><a href="#pod存在意义" class="headerlink" title="pod存在意义"></a>pod存在意义</h3><ul>
<li>创建容器使用docker，一个容器运行一个程序，单进程设计</li>
<li>pod是多进程设计，每个pod多个容器，一个容器运行一个程序</li>
<li>pod存在是为了亲密性应用（应用之间进行交互、网络调用）</li>
</ul>
<h3 id="pod实现机制"><a href="#pod实现机制" class="headerlink" title="pod实现机制"></a>pod实现机制</h3><ul>
<li><p>共享网络</p>
<p>通过Pause容器，将其他业务容器都加入到Pause容器，而让所有业务容器处于同一个host，实现网络共享</p>
</li>
<li><p>共享存储</p>
<p>使用数据卷Volumn进行持久化存储</p>
</li>
</ul>
<h3 id="镜像拉取策略"><a href="#镜像拉取策略" class="headerlink" title="镜像拉取策略"></a>镜像拉取策略</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.14</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<ul>
<li>IfNotPresent：默认值，镜像在宿主机上不存在时才拉取</li>
<li>Always：每次创建Pod都会重新拉取一次镜像</li>
<li>Never：pod永远不会主动拉取这个镜像</li>
</ul>
<h3 id="资源限制"><a href="#资源限制" class="headerlink" title="资源限制"></a>资源限制</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">env:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;password&quot;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">&quot;64Mi&quot;</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">&quot;128Mi&quot;</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<h3 id="Pod重启机制"><a href="#Pod重启机制" class="headerlink" title="Pod重启机制"></a>Pod重启机制</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.28.4</span></span><br><span class="line">    <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Always：当容器终止退出后，总是重启容器，默认策略</li>
<li>OnFailure：当容器异常退出（退出状态码非0）时，才重启容器</li>
<li>Never：当容器终止退出，从不重启容器</li>
</ul>
<h3 id="Pod健康检查"><a href="#Pod健康检查" class="headerlink" title="Pod健康检查"></a>Pod健康检查</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: liveness</span><br><span class="line">      image: busybox</span><br><span class="line">      livenessProbe:</span><br><span class="line">        exec:</span><br><span class="line">          command:</span><br><span class="line">          - cat</span><br><span class="line">          - &#x2F;tmp&#x2F;healthy</span><br><span class="line">        initialDelaySecond: 5</span><br><span class="line">        periodSecond: 5</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<ul>
<li><p>livenessProbe(存活检查)</p>
<p>如果检测失败，杀死容器，根据Pod的restartPolicy来操作</p>
</li>
<li><p>readinessProbe(就绪检查)</p>
<p>如果检查失败，将Pod从service endpoints中剔除</p>
</li>
</ul>
<p>三种检查方式</p>
<ol>
<li>httpGet ：发送请求返回200-400为成功</li>
<li>exec ： 执行Shell命令返回状态码0为成功</li>
<li>tcpSocket：发起TCP Socket建立连接成功</li>
</ol>
<h3 id="Pod调度策略"><a href="#Pod调度策略" class="headerlink" title="Pod调度策略"></a>Pod调度策略</h3><p>1、create pod 时调用 apiserver 将pod信息存入 etcd<br>2、scheduler 通过 apiserver 发现有新pod需创建，再通过apiserver从etcd中获取pod信息，根据调度算法将pod调度到某个node节点<br>3、kubelet 通过apiserver读取etcd拿到分配给当前node的pod信息，docker创建容器</p>
<h3 id="影响调度的因素"><a href="#影响调度的因素" class="headerlink" title="影响调度的因素"></a>影响调度的因素</h3><ul>
<li><p>资源限制</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">requests:</span></span><br><span class="line">  <span class="attr">memory:</span> <span class="string">&quot;64Mi&quot;</span></span><br><span class="line">  <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br></pre></td></tr></table></figure>

<p>根据request找到资源足够的node节点进行调度</p>
</li>
<li><p>标签选择器(可以用于部署开发、测试、生产环境)</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">env_role:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>

<p>根据node标签指定调度位置</p>
<p>通过命令<code>kubectl label node cluster2 env_role=dev</code> 给node节点标记</p>
<p><code>kubectl get nodes --show-labels</code>查看标签</p>
</li>
<li><p>节点亲和性</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">          <span class="attr">values:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">dev</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpression:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">group</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">otherprod</span></span><br></pre></td></tr></table></figure>

<p>与nodeSelector差不多，根据标签决定调度到哪台node</p>
<ul>
<li>硬亲和性：约束条件必须满足</li>
<li>软亲和性：尝试满足，但不保证</li>
</ul>
<p>支持操作符：In NotIn Exists Gt Lt DoesNotExists</p>
</li>
<li><p>污点</p>
<p>nodSelector和nodeAffinity是Pod的属性，pod调度到某些节点上时实现</p>
<p>Taint污点：节点不做普通分配，是节点的属性</p>
<p>场景</p>
<ul>
<li>专用节点</li>
<li>配置特定硬件节点</li>
<li>基于Traint驱逐</li>
</ul>
<p>查看节点污点情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe node cluster1 | grep Taint</span><br></pre></td></tr></table></figure>

<p>污点值有三个：</p>
<ul>
<li>NoSchedule:一定不被调度</li>
<li>PreferNoSchedule:尽量不被调度</li>
<li>NoExecute：不会调度,并且还会驱逐Node已有Pod</li>
</ul>
<p>为节点添加污点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node [node] key=value:三个污点值</span><br></pre></td></tr></table></figure>

<p>示例</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建5个Nginx的pod</span></span><br><span class="line">kubectl create deployment web --image=nginx</span><br><span class="line">kubectl scale deployment web --replicas=5</span><br><span class="line"><span class="meta">#</span><span class="bash">此时可看到5个pod分布在各个节点</span></span><br><span class="line">kubectl get pods -o wide</span><br><span class="line"><span class="meta">#</span><span class="bash">删除pod</span></span><br><span class="line">kubectl delete deployment web</span><br><span class="line"><span class="meta">#</span><span class="bash">打污点</span></span><br><span class="line">kubectl taint node cluster2 env=yes:NoSchedule</span><br><span class="line"><span class="meta">#</span><span class="bash">查看污点</span></span><br><span class="line">kubectl describe node cluster2 | grep Taint</span><br><span class="line"><span class="meta">#</span><span class="bash">Taints:             env=yes:NoSchedule</span></span><br><span class="line"><span class="meta">#</span><span class="bash">再次创建5个pod</span></span><br><span class="line">kubectl create deployment web --image=nginx</span><br><span class="line">kubectl scale deployment web --replicas=5</span><br><span class="line"><span class="meta">#</span><span class="bash">此时可看到打上污点的node不再被分配pod</span></span><br><span class="line">kubectl get pods -o wide</span><br><span class="line"><span class="meta">#</span><span class="bash">删除污点</span></span><br><span class="line">kubectl taint node cluster2 env:NoSchedule-</span><br></pre></td></tr></table></figure>
</li>
<li><p>污点容忍</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tolerations:</span>  <span class="comment">#容忍污点</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;value&quot;</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="Controller-deployment"><a href="#Controller-deployment" class="headerlink" title="Controller(deployment)"></a>Controller(deployment)</h2><h3 id="基本概念-1"><a href="#基本概念-1" class="headerlink" title="基本概念"></a>基本概念</h3><ul>
<li>Controller是在集群上管理和运行容器的对象</li>
<li>Pod通过Controller实现应用的运维，如伸缩、滚动升级等</li>
<li>Pod和Controller之间通过标签建立关系label-selector</li>
</ul>
<h3 id="deployment控制器的应用"><a href="#deployment控制器的应用" class="headerlink" title="deployment控制器的应用"></a>deployment控制器的应用</h3><ul>
<li>部署无状态应用</li>
<li>管理Pod和ReplicaSet</li>
<li>部署、滚动升级等</li>
</ul>
<p>场景：web服务、微服务</p>
<h3 id="使用deployment部署应用-yaml"><a href="#使用deployment部署应用-yaml" class="headerlink" title="使用deployment部署应用(yaml)"></a>使用deployment部署应用(yaml)</h3><p>导出yaml文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment web --image&#x3D;nginx -o yaml --dry-run &gt;web.yaml</span><br></pre></td></tr></table></figure>

<p>修改文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>使用yaml部署应用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f web.yaml</span><br></pre></td></tr></table></figure>

<p>对外进行发布（暴露对外端口）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span></span><br><span class="line"></span><br><span class="line"><span class="bash">kubectl expose deployment web --port=80 --<span class="built_in">type</span>=NodePort --target-port=80 --name=web1 -o yaml&gt;web1.yaml</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2020-12-25T03:58:07Z&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">managedFields:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">fieldsType:</span> <span class="string">FieldsV1</span></span><br><span class="line">    <span class="attr">fieldsV1:</span></span><br><span class="line">      <span class="attr">f:metadata:</span></span><br><span class="line">        <span class="attr">f:labels:</span></span><br><span class="line">          <span class="string">.:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:app:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">f:spec:</span></span><br><span class="line">        <span class="attr">f:externalTrafficPolicy:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">f:ports:</span></span><br><span class="line">          <span class="string">.:</span> &#123;&#125;</span><br><span class="line">          <span class="string">k:&#123;&quot;port&quot;:80,&quot;protocol&quot;:&quot;TCP&quot;&#125;:</span></span><br><span class="line">            <span class="string">.:</span> &#123;&#125;</span><br><span class="line">            <span class="attr">f:port:</span> &#123;&#125;</span><br><span class="line">            <span class="attr">f:protocol:</span> &#123;&#125;</span><br><span class="line">            <span class="attr">f:targetPort:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">f:selector:</span></span><br><span class="line">          <span class="string">.:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:app:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">f:sessionAffinity:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">f:type:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">manager:</span> <span class="string">kubectl-expose</span></span><br><span class="line">    <span class="attr">operation:</span> <span class="string">Update</span></span><br><span class="line">    <span class="attr">time:</span> <span class="string">&quot;2020-12-25T03:58:06Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;112853&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">db90ad2d-8538-4844-9e2b-f01e5bff8b84</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.10</span><span class="number">.106</span><span class="number">.70</span></span><br><span class="line">  <span class="attr">clusterIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.10</span><span class="number">.106</span><span class="number">.70</span></span><br><span class="line">  <span class="attr">externalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">nodePort:</span> <span class="number">31014</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="应用升级回滚和弹性伸缩"><a href="#应用升级回滚和弹性伸缩" class="headerlink" title="应用升级回滚和弹性伸缩"></a>应用升级回滚和弹性伸缩</h3><p>升级</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl set image deployment web nginx=nginx:1.15</span><br></pre></td></tr></table></figure>

<p>查看升级状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout status deployment web</span><br></pre></td></tr></table></figure>

<p>查看升级历史</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout history deployment web</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deployment.apps&#x2F;web </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>回滚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployment web  #回滚到上一个版本</span><br><span class="line">kubectl rollout undo deployment web --to-revision=1 #回滚到指定编号的版本</span><br></pre></td></tr></table></figure>

<p>弹性伸缩</p>
<p>将pod副本的值伸缩至10个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment web --replicas&#x3D;10</span><br></pre></td></tr></table></figure>

<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><h3 id="service意义"><a href="#service意义" class="headerlink" title="service意义"></a>service意义</h3><ul>
<li>防止Pod失联（服务发现），类似服务注册中心</li>
<li>定义pod访问策略（负载均衡）</li>
</ul>
<h3 id="Pod与Service关系"><a href="#Pod与Service关系" class="headerlink" title="Pod与Service关系"></a>Pod与Service关系</h3><ul>
<li>通过service实现pod的负载均衡</li>
<li>根据label和selector建立关联关系</li>
</ul>
<h3 id="常用service类型"><a href="#常用service类型" class="headerlink" title="常用service类型"></a>常用service类型</h3><ul>
<li>ClusterIP  集群内部使用</li>
<li>NodePort  对外访问应用</li>
<li>LoadBalancer   对外访问应用，负载均衡</li>
</ul>
<h2 id="Controller-StatefulSet、DaemonSet、Job、cronJob"><a href="#Controller-StatefulSet、DaemonSet、Job、cronJob" class="headerlink" title="Controller(StatefulSet、DaemonSet、Job、cronJob)"></a>Controller(StatefulSet、DaemonSet、Job、cronJob)</h2><h3 id="无状态应用："><a href="#无状态应用：" class="headerlink" title="无状态应用："></a>无状态应用：</h3><ul>
<li>认为所有Pod都是一样的</li>
<li>启动顺序无要求</li>
<li>不用考虑在哪个node运行</li>
<li>可随意伸缩扩展</li>
</ul>
<h3 id="有状态应用："><a href="#有状态应用：" class="headerlink" title="有状态应用："></a>有状态应用：</h3><ul>
<li><p>以上无状态应用的所有因素都需要考虑到</p>
</li>
<li><p>每个pod都是独立的，保证pod的启动顺序和唯一性</p>
<ul>
<li>有唯一的网络标识、持久化存储</li>
<li>有序，比如mysql主从</li>
</ul>
</li>
</ul>
<h3 id="部署有状态应用StatefulSet"><a href="#部署有状态应用StatefulSet" class="headerlink" title="部署有状态应用StatefulSet"></a>部署有状态应用StatefulSet</h3><p><code>vi sts.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-statefulset</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p><code>kubectl apply -f sts.yaml</code></p>
<p>查看pod</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@cluster1 ~]# kubectl get pod -o wide</span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE   IP               NODE       NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-statefulset-0   1&#x2F;1     Running   0          84s   10.122.61.9      cluster2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-statefulset-1   1&#x2F;1     Running   0          71s   10.122.146.205   cluster3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-statefulset-2   1&#x2F;1     Running   0          45s   10.122.146.206   cluster3   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>查看service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@cluster1 ~]# kubectl get svc -o wide</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE     SELECTOR</span><br><span class="line">kubernetes   ClusterIP   10.10.0.1    &lt;none&gt;        443&#x2F;TCP   28h     &lt;none&gt;</span><br><span class="line">nginx        ClusterIP   None         &lt;none&gt;        80&#x2F;TCP    5m28s   app&#x3D;nginx</span><br></pre></td></tr></table></figure>

<p>与deployment区别：</p>
<p>有唯一标识，每个pod有唯一主机名，唯一域名格式=主机名.service名.名称空间.svc.cluster.local</p>
<p><code> nginx-statefulset-0.nginx.default.svc.cluster.local</code></p>
<h3 id="部署守护进程DaemonSet"><a href="#部署守护进程DaemonSet" class="headerlink" title="部署守护进程DaemonSet"></a>部署守护进程DaemonSet</h3><p><code>vi ds.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ds-test</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">filebeat</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">logs</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/tmp/log</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启动<code>kubectl apply -f ds.yaml</code></p>
<p>进入一个pod中</p>
<p><code>kubectl exec -it ds-test-5dszw bash </code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@ds-test-5dszw:/# cd /tmp/log/</span><br><span class="line">root@ds-test-5dszw:/tmp/log# ls</span><br><span class="line">audit	  boot.log-20201223  calico  cloud-init.log  cron   dmesg.old  grubby_prune_debug  maillog   pods     rhsm    spooler	tuned  yum.log</span><br><span class="line">boot.log  btmp		     chrony  containers      dmesg  glusterfs  lastlog		   messages  qemu-ga  secure  tallylog	wtmp</span><br><span class="line">root@ds-test-5dszw:/tmp/log# exit</span><br><span class="line">exit</span><br><span class="line">[root@cluster1 ~]#</span><br></pre></td></tr></table></figure>

<h3 id="Job一次性任务"><a href="#Job一次性任务" class="headerlink" title="Job一次性任务"></a>Job一次性任务</h3><p><code>vi job.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">pi</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pi</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">perl</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;perl&quot;</span>,<span class="string">&quot;-Mbignum=bpi&quot;</span>,<span class="string">&quot;-wle&quot;</span>,<span class="string">&quot;print bpi(2000)&quot;</span>]</span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">backoffLimit:</span> <span class="number">4</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看任务</p>
<p><code>kubectl get jobs</code></p>
<p>查看pod打印log</p>
<p><code>kubectl logs pi-5qwh2 </code></p>
<p>删除</p>
<p><code>kubectl delete -f job.yaml</code></p>
<h3 id="CronJob定时任务"><a href="#CronJob定时任务" class="headerlink" title="CronJob定时任务"></a>CronJob定时任务</h3><p><code>vi cron.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;*/1 * * * *&quot;</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">date;</span> <span class="string">echo</span> <span class="string">Hello</span> <span class="string">from</span> <span class="string">k8s</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br></pre></td></tr></table></figure>

<h2 id="配置管理-Secret"><a href="#配置管理-Secret" class="headerlink" title="配置管理(Secret)"></a>配置管理(Secret)</h2><p>作用：加密数据存在etcd里，让Pod容器以挂载Volume方式进行访问，场景：凭证</p>
<p>创建secret加密数据</p>
<p><code>vi secret.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">cm9vdAo=</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">aGlzZW5zZQo=</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f secret.yaml</span><br><span class="line">kubectl get secret</span><br></pre></td></tr></table></figure>

<p><strong>以变量形式挂载到pod容器</strong></p>
<p><code>vi secret-val.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SECRET_USERNAME</span></span><br><span class="line">        <span class="attr">valueFrom:</span></span><br><span class="line">          <span class="attr">secretKeyRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">username</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SECRET_PASSWORD</span></span><br><span class="line">        <span class="attr">valueFrom:</span></span><br><span class="line">          <span class="attr">secretKeyRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">password</span></span><br></pre></td></tr></table></figure>

<p><code>kubectl apply -f secret-val.yaml</code></p>
<p>进入容器查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@cluster1 ~]# kubectl exec -it mypod bash</span><br><span class="line">root@mypod:&#x2F;# echo $SECRET_USERNAME</span><br><span class="line">root</span><br><span class="line">root@mypod:&#x2F;# echo $SECRET_PASSWORD</span><br><span class="line">hisense</span><br><span class="line">root@mypod:&#x2F;# </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>以数据卷(Volume)形式挂载到容器</strong></p>
<p><code>vi secret-vol.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/etc/foo&quot;</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">mysecret</span></span><br></pre></td></tr></table></figure>

<p><code>kubectl apply -f secret-vol.yaml</code></p>
<p>进入容器查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@cluster1 ~]# kubectl exec -it mypod bash</span><br><span class="line">root@mypod2:&#x2F;# ls &#x2F;etc&#x2F;foo&#x2F;</span><br><span class="line">password  username</span><br><span class="line">root@mypod2:&#x2F;# cd &#x2F;etc&#x2F;foo&#x2F;</span><br><span class="line">root@mypod2:&#x2F;etc&#x2F;foo# cat password </span><br><span class="line">hisense</span><br><span class="line">root@mypod2:&#x2F;etc&#x2F;foo# cat username </span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<h2 id="配置管理-ConfigMap"><a href="#配置管理-ConfigMap" class="headerlink" title="配置管理(ConfigMap)"></a>配置管理(ConfigMap)</h2><p>作用：存储非加密的数据到etcd，让pod以变量或volume挂载到容器，场景：配置文件</p>
<p>以redis为例：</p>
<p><strong>创建配置文件</strong></p>
<p><code>vi redis.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="meta">redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="meta">redis.password</span>=<span class="string">123456</span></span><br></pre></td></tr></table></figure>

<p><strong>创建configmap</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap redis-config --from-file&#x3D;redis.properties</span><br></pre></td></tr></table></figure>

<p>查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@cluster1 ~]# kubectl get cm</span><br><span class="line">NAME               DATA   AGE</span><br><span class="line">kube-root-ca.crt   1      4d22h</span><br><span class="line">redis-config       1      48s</span><br><span class="line">[root@cluster1 ~]# kubectl describe cm redis-config</span><br><span class="line">Name:         redis-config</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">redis.properties:</span><br><span class="line">----</span><br><span class="line">redis.host&#x3D;127.0.0.1</span><br><span class="line">redis.port&#x3D;6379</span><br><span class="line">redis.password&#x3D;123456</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p><strong>以volume挂载到容器</strong></p>
<p><code>vi cm.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;cat /etc/config/redis.properties&quot;</span>]</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/etc/config&quot;</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-config</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@cluster1 ~]# kubectl get cm</span><br><span class="line">NAME               DATA   AGE</span><br><span class="line">kube-root-ca.crt   1      4d22h</span><br><span class="line">redis-config       1      2m46s</span><br><span class="line">[root@cluster1 ~]# vi cm.yaml</span><br><span class="line">[root@cluster1 ~]# kubectl apply -f cm.yaml </span><br><span class="line">pod/mypod3 created</span><br><span class="line">[root@cluster1 ~]# kubectl get pod</span><br><span class="line">NAME                  READY   STATUS      RESTARTS   AGE</span><br><span class="line">mypod3                0/1     Completed   0          35s</span><br><span class="line">[root@cluster1 ~]# kubectl logs mypod3</span><br><span class="line">redis.host=127.0.0.1</span><br><span class="line">redis.port=6379</span><br><span class="line">redis.password=123456</span><br></pre></td></tr></table></figure>

<p><strong>以变量形式挂载</strong></p>
<p><code>vi myconfig.yaml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: myconfig</span><br><span class="line">data:</span><br><span class="line">  special.level: info</span><br><span class="line">  special.type: hello</span><br></pre></td></tr></table></figure>

<p><code>kubectl apply -f myconfig.yaml</code></p>
<p>创建pod</p>
<p><code>vi config-val.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod4</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo $(LEVEL) $(TYPE)&quot;</span>]</span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LEVEL</span></span><br><span class="line">        <span class="attr">valueFrom:</span></span><br><span class="line">          <span class="attr">configMapKeyRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">myconfig</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">special.level</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TYPE</span></span><br><span class="line">        <span class="attr">valueFrom:</span></span><br><span class="line">          <span class="attr">configMapKeyRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">myconfig</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">special.type</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<p><code>kubectl apply -f config-var.yaml</code></p>
<p>查看日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@cluster1 ~]# kubectl logs mypod4</span><br><span class="line">info hello</span><br></pre></td></tr></table></figure>

<h1 id="k8s集群安全机制"><a href="#k8s集群安全机制" class="headerlink" title="k8s集群安全机制"></a>k8s集群安全机制</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><ul>
<li>访问k8s集群时，需要经过三步：<ul>
<li>认证<ul>
<li>传输安全：对外不暴露8080端口，只能内部访问，对外使用端口6443</li>
<li>认证：客户端认证常用方式：①https证书认证，基于ca证书 ②http token认证，通过token识别用户③http基本认证，用户名+密码认证</li>
</ul>
</li>
<li>授权（鉴权）<ul>
<li>基于RBAC进行鉴权操作，基于角色的访问控制</li>
</ul>
</li>
<li>准入控制<ul>
<li>准入控制器的列表，如列表有请求的内容，通过，无则拒绝</li>
</ul>
</li>
</ul>
</li>
<li>访问时都需要经过apiserver，apiserver做统一协调，访问过程中需要证书、token、或用户名密码，如访问pod还需要serviceAccount</li>
</ul>
<h2 id="RBAC-基于角色的访问控制"><a href="#RBAC-基于角色的访问控制" class="headerlink" title="RBAC 基于角色的访问控制"></a>RBAC 基于角色的访问控制</h2><ul>
<li>角色：<ul>
<li>role：特定命名空间访问权限</li>
<li>clusterRole：所有命名空间访问权限</li>
</ul>
</li>
<li>角色绑定<ul>
<li>roleBinding：角色绑定到主体</li>
<li>clusterRoleBinding：集群角色绑定到主体</li>
</ul>
</li>
<li>主体<ul>
<li>user：用户</li>
<li>group：用户组</li>
<li>serviceAccount：服务账号</li>
</ul>
</li>
</ul>
<p><strong>步骤</strong></p>
<ol>
<li><p>创建命名空间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns roledemo</span><br><span class="line">kubectl get ns</span><br></pre></td></tr></table></figure>
</li>
<li><p>在该命名空间创建pod</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl run nginx --image&#x3D;nginx -n roledemo</span><br><span class="line">#查看pod</span><br><span class="line">kubectl get pod -n roledemo</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建角色</p>
<p><code>vi rbac-role.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">roledemo</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>] <span class="comment"># &quot;&quot; indicates the core API group</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;watch&quot;</span>,<span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><code>kubectl apply -f rbac-role.yaml</code></p>
<p>查看</p>
<p><code>kubectl get role -n roledemo</code></p>
</li>
<li><p>创建角色绑定</p>
<p><code>vi rbac-rolebinding.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">roledemo</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-pods</span></span><br><span class="line"><span class="attr">subjects:</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lhb</span> <span class="comment">#Name is case sensitive</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span> <span class="comment">#this must be Role or ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span></span><br><span class="line"> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<p><code>kubectl apply -f rbac-rolebinding.yaml</code></p>
<p>查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@cluster1 k8s-learn]# kubectl get role,rolebinding -n roledemo</span><br><span class="line">NAME                                        CREATED AT</span><br><span class="line">role.rbac.authorization.k8s.io&#x2F;pod-reader   2020-12-29T09:56:37Z</span><br><span class="line"></span><br><span class="line">NAME                                              ROLE              AGE</span><br><span class="line">rolebinding.rbac.authorization.k8s.io&#x2F;read-pods   Role&#x2F;pod-reader   50s</span><br></pre></td></tr></table></figure>
</li>
<li><p>证书</p>
</li>
</ol>
<h1 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h1><p>Ingress和pod之间通过service关联，Ingress作为统一入口，由service关联一组pod</p>
<ol>
<li>部署ingress controller</li>
<li>创建ingress规则</li>
</ol>
<h2 id="安装ingress-controller"><a href="#安装ingress-controller" class="headerlink" title="安装ingress controller"></a>安装ingress controller</h2><p>参考<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/deploy/#using-helm">官方说明</a>  </p>
<p><strong>安装方式一：</strong></p>
<p>下载安装文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;kubernetes&#x2F;ingress-nginx&#x2F;controller-v0.43.0&#x2F;deploy&#x2F;static&#x2F;provider&#x2F;baremetal&#x2F;deploy.yaml</span><br></pre></td></tr></table></figure>

<p>由于众所周知的原因，在国内k8s.gcr.io仓库里的镜像是拉取不到的，因此需要手动在机器上拉取阿里的镜像并修改tag</p>
<p>先将下载下来的deploy.yaml去掉镜像<code>k8s.gcr.io/ingress-nginx/controller:v0.43.0@sha256:9bba603b99bf25f6d117cf1235b6598c16033ad027b143c90fa5b3cc583c5713</code>后的校验码，因为当k8s发现本地的镜像校验码不一致时还是会去k8s.gcr.io中拉取，修改后如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">      dnsPolicy: ClusterFirst</span><br><span class="line">      containers:</span><br><span class="line">        - name: controller</span><br><span class="line">          image: k8s.gcr.io&#x2F;ingress-nginx&#x2F;controller:v0.43.0</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          lifecycle:</span><br><span class="line">            preStop:</span><br><span class="line">              exec:</span><br><span class="line">                command:</span><br><span class="line">                  - &#x2F;wait-shutdown</span><br></pre></td></tr></table></figure>



<p>拉取nginx-ingress-controller镜像</p>
<p><code>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v0.43.0</code></p>
<p>重新打tag</p>
<p><code>docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v0.43.0 k8s.gcr.io/ingress-nginx/controller:v0.43.0</code></p>
<p>安装</p>
<p><code>kubectl apply -f deploy.yaml</code></p>
<p>验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n ingress-nginx -l app.kubernetes.io&#x2F;name&#x3D;ingress-nginx --watch</span><br></pre></td></tr></table></figure>

<p>看到ingress-nginx-controller状态为running表示安装成功</p>
<p><strong>安装方式二(helm)：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span><br><span class="line">helm repo update</span><br><span class="line"></span><br><span class="line">helm install my-ingress-nginx ingress-nginx/ingress-nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">NAME: my-ingress-nginx</span><br><span class="line">LAST DEPLOYED: Fri Jan  8 13:37:21 2021</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">The ingress-nginx controller has been installed.</span><br><span class="line">It may take a few minutes for the LoadBalancer IP to be available.</span><br><span class="line">You can watch the status by running &#39;kubectl --namespace default get services -o wide -w my-ingress-nginx-controller&#39;</span><br><span class="line"></span><br><span class="line">An example Ingress that makes use of the controller:</span><br><span class="line"></span><br><span class="line">  apiVersion: networking.k8s.io&#x2F;v1beta1</span><br><span class="line">  kind: Ingress</span><br><span class="line">  metadata:</span><br><span class="line">    annotations:</span><br><span class="line">      kubernetes.io&#x2F;ingress.class: nginx</span><br><span class="line">    name: example</span><br><span class="line">    namespace: foo</span><br><span class="line">  spec:</span><br><span class="line">    rules:</span><br><span class="line">      - host: www.example.com</span><br><span class="line">        http:</span><br><span class="line">          paths:</span><br><span class="line">            - backend:</span><br><span class="line">                serviceName: exampleService</span><br><span class="line">                servicePort: 80</span><br><span class="line">              path: &#x2F;</span><br><span class="line">    # This section is only required if TLS is to be enabled for the Ingress</span><br><span class="line">    tls:</span><br><span class="line">        - hosts:</span><br><span class="line">            - www.example.com</span><br><span class="line">          secretName: example-tls</span><br><span class="line"></span><br><span class="line">If TLS is enabled for the Ingress, a Secret containing the certificate and key must also be provided:</span><br><span class="line"></span><br><span class="line">  apiVersion: v1</span><br><span class="line">  kind: Secret</span><br><span class="line">  metadata:</span><br><span class="line">    name: example-tls</span><br><span class="line">    namespace: foo</span><br><span class="line">  data:</span><br><span class="line">    tls.crt: &lt;base64 encoded cert&gt;</span><br><span class="line">    tls.key: &lt;base64 encoded key&gt;</span><br><span class="line">  type: kubernetes.io&#x2F;tls</span><br></pre></td></tr></table></figure>

<p>helm安装方式也需要解决镜像拉取不到的问题，思路与方式一类似</p>
<h2 id="配置ingress"><a href="#配置ingress" class="headerlink" title="配置ingress"></a>配置ingress</h2><p>步骤</p>
<ol>
<li><p>创建nginx pod并暴露端口</p>
<p><code>kubectl create deployment web --image=nginx</code></p>
<p><code>kubectl expose deployment web --port=80 --target-port=80 --type=NodePort</code></p>
</li>
<li><p>添加ingress</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">example.ingredemo.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">web</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> <code>kubectl apply -f ingress.yaml</code></p>
<p>查看ingress controller</p>
<p><code>kubectl get pods -n ingress-nginx -o wide</code></p>
<p>查看ingress</p>
<p><code>kubectl get ing</code></p>
</li>
<li><p>访问</p>
<p>添加映射 10.xx.xx.xx  example.ingredemo.com</p>
</li>
</ol>
<h1 id="Helm"><a href="#Helm" class="headerlink" title="Helm"></a>Helm</h1><p>优势：使用helm可以将多个yaml作为一个整体管理；实现yaml高效复用；使用heml实现应用级别的版本管理</p>
<p>Helm是一个Kubernetes的包管理工具，就像Linux下的包管理器，如yum/apt等，可以很方便的将之前打包好的yaml文件部署到kubernetes上。</p>
<p>Helm有三个重要概念</p>
<ul>
<li>helm：一个命令行客户端工具，主要用于Kubernetes应用chart的创建、打包、发布和管理</li>
<li>Chart：应用描述，一系列用于描述k8s资源相关文件的集合</li>
<li>Release：基于Chart的部署实体，一个chart被Helm运行后将会生成对应的release，将在K8S中创建出真实的运行资源对象。也就是应用级别的版本管理</li>
<li>Repository：用于发布和存储Chart的仓库 </li>
</ul>
<h2 id="helm安装"><a href="#helm安装" class="headerlink" title="helm安装"></a>helm安装</h2><p>下载helm压缩文件，解压，将helm文件拷贝到/usr/bin</p>
<h2 id="helm配置仓库"><a href="#helm配置仓库" class="headerlink" title="helm配置仓库"></a>helm配置仓库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 配置源</span></span><br><span class="line">helm repo add azure http://mirror.azure.cn/kubernetes/charts</span><br><span class="line">helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line"><span class="meta">#</span><span class="bash">更新</span></span><br><span class="line">helm repo update</span><br><span class="line"><span class="meta">#</span><span class="bash">查看</span></span><br><span class="line">helm repo list</span><br><span class="line"><span class="meta">#</span><span class="bash">删除</span></span><br><span class="line">helm repo remove aliyun</span><br></pre></td></tr></table></figure>

<h2 id="使用helm快速部署应用"><a href="#使用helm快速部署应用" class="headerlink" title="使用helm快速部署应用"></a>使用helm快速部署应用</h2><ol>
<li><p>搜索需要安装的应用(weave)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@cluster1 k8s-learn]# helm search repo weave</span><br><span class="line">NAME              	CHART VERSION	APP VERSION	DESCRIPTION                                       </span><br><span class="line">aliyun&#x2F;weave-cloud	0.1.2        	           	Weave Cloud is a add-on to Kubernetes which pro...</span><br><span class="line">aliyun&#x2F;weave-scope	0.9.2        	1.6.5      	A Helm chart for the Weave Scope cluster visual...</span><br><span class="line">azure&#x2F;weave-cloud 	0.3.9        	1.4.0      	DEPRECATED - Weave Cloud is a add-on to Kuberne...</span><br><span class="line">azure&#x2F;weave-scope 	1.1.12       	1.12.0     	DEPRECATED - A Helm chart for the Weave Scope c...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装应用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> helm install 安装后的名称 需要安装的名称</span></span><br><span class="line">helm install ws aliyun/weave-scope</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看</span></span><br><span class="line">helm status ws</span><br><span class="line">kubectl get pod</span><br><span class="line">kubectl get svc</span><br></pre></td></tr></table></figure>

<p>修改service，改为NodePort方式 对外暴露端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">将spec.type由ClusterIP改为NodePort</span></span><br><span class="line">kubectl edit svc ws-weave-scope</span><br><span class="line"></span><br></pre></td></tr></table></figure>



</li>
</ol>
<h2 id="自定义chart"><a href="#自定义chart" class="headerlink" title="自定义chart"></a>自定义chart</h2><ol>
<li><p>创建chart</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@cluster1 k8s-learn]# helm create mychart</span><br><span class="line">Creating mychart</span><br><span class="line">[root@cluster1 k8s-learn]# cd mychart&#x2F;</span><br><span class="line">[root@cluster1 mychart]# ll -a</span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x 4 root root   93 Dec 30 17:18 .</span><br><span class="line">drwxr-xr-x 4 root root 4096 Dec 30 17:18 ..</span><br><span class="line">drwxr-xr-x 2 root root    6 Dec 30 17:18 charts</span><br><span class="line">-rw-r--r-- 1 root root 1098 Dec 30 17:18 Chart.yaml</span><br><span class="line">-rw-r--r-- 1 root root  349 Dec 30 17:18 .helmignore</span><br><span class="line">drwxr-xr-x 3 root root  162 Dec 30 17:18 templates</span><br><span class="line">-rw-r--r-- 1 root root 1800 Dec 30 17:18 values.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>Chart.yml：当前chart属性配置信息</li>
<li>templates：编写的yaml文件放在该目录</li>
<li>values.yaml：存放全局变量</li>
</ul>
</li>
<li><p>templates中创建文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 导出deployment.yaml</span></span><br><span class="line">kubectl create deployment web1 --image=nginx -o yaml &gt; deployment.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 导出service.yaml 【需要创建 deployment，不然会报错】</span></span><br><span class="line">kubectl expose deployment web1 --port=80 --target-port=80 --type=NodePort --dry-run -o yaml &gt; service.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 把刚创建的web1 pod删除</span></span><br><span class="line">kubectl delete deployment web1</span><br><span class="line"></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><p>安装mychart</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install web1 mychart&#x2F;</span><br></pre></td></tr></table></figure>
</li>
<li><p>应用升级</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade web1 mychart&#x2F;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="实现yaml高效复用"><a href="#实现yaml高效复用" class="headerlink" title="实现yaml高效复用"></a>实现yaml高效复用</h2><p>通过传递参数，动态渲染模板，yaml内容动态从传入参数生成</p>
<ol>
<li>在values.yaml定义变量和值</li>
<li>在具体yaml中获取变量值</li>
<li>yaml文件中大致有几个位置不同<ul>
<li>image</li>
<li>tag</li>
<li>label</li>
<li>port</li>
<li>replicas</li>
</ul>
</li>
</ol>
<p><strong>实现步骤：</strong></p>
<ol>
<li><p>values.yaml定义变量</p>
<p><code>vi values.yaml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">replicas: 1</span><br><span class="line">image: nginx</span><br><span class="line">tag: 1.16</span><br><span class="line">label: nginx</span><br><span class="line">port: 80</span><br></pre></td></tr></table></figure>
</li>
<li><p>templates的yaml中使用变量</p>
<p>变量表达式：<code>&#123;&#123; .Values.变量名称 &#125;&#125;</code></p>
<p><code>vi deployment.yaml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    app: web1</span><br><span class="line">  name: &#123;&#123;.Release.Name&#125;&#125;-deploy</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: &#123;&#123;.Values.label&#125;&#125;</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">        app: &#123;&#123;.Values.label&#125;&#125;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: &#123;&#123;.Values.image&#125;&#125;</span><br><span class="line">        name: nginx</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><code>vi service.yaml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    app: web1</span><br><span class="line">  name: &#123;&#123;.Release.Name&#125;&#125;-svc</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: &#123;&#123;.Values.port&#125;&#125;</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: &#123;&#123;.Values.label&#125;&#125;</span><br><span class="line">  type: NodePort</span><br><span class="line">status:</span><br><span class="line">  loadBalancer: &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>尝试执行</p>
</li>
</ol>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@cluster1 k8s-learn]# helm install --dry-run web2 mychart&#x2F;</span><br><span class="line">NAME: web2</span><br><span class="line">LAST DEPLOYED: Wed Dec 30 18:53:26 2020</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: pending-install</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">HOOKS:</span><br><span class="line">MANIFEST:</span><br><span class="line">---</span><br><span class="line"># Source: mychart&#x2F;templates&#x2F;service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    app: web1</span><br><span class="line">  name: web2-svc</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  type: NodePort</span><br><span class="line">status:</span><br><span class="line">  loadBalancer: &#123;&#125;</span><br><span class="line">---</span><br><span class="line"># Source: mychart&#x2F;templates&#x2F;deployment.yaml</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    app: web1</span><br><span class="line">  name: web2-deploy</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx</span><br><span class="line">        name: nginx</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>完成创建</li>
</ol>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@cluster1 k8s-learn]# helm install web2 mychart&#x2F;</span><br><span class="line">NAME: web2</span><br><span class="line">LAST DEPLOYED: Wed Dec 30 18:57:52 2020</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line"></span><br><span class="line">[root@cluster1 k8s-learn]# kubectl get pod,svc</span><br><span class="line">NAME                                               READY   STATUS      RESTARTS   AGE</span><br><span class="line">pod&#x2F;ds-test-5dszw                                  1&#x2F;1     Running     0          5d2h</span><br><span class="line">pod&#x2F;ds-test-jmm4v                                  1&#x2F;1     Running     0          5d2h</span><br><span class="line">pod&#x2F;mypod                                          1&#x2F;1     Running     0          5d1h</span><br><span class="line">pod&#x2F;mypod2                                         1&#x2F;1     Running     0          32h</span><br><span class="line">pod&#x2F;mypod3                                         0&#x2F;1     Completed   0          31h</span><br><span class="line">pod&#x2F;mypod4                                         0&#x2F;1     Completed   0          31h</span><br><span class="line">pod&#x2F;weave-scope-agent-ws-44cq2                     1&#x2F;1     Running     0          117m</span><br><span class="line">pod&#x2F;weave-scope-agent-ws-9ssb5                     1&#x2F;1     Running     0          117m</span><br><span class="line">pod&#x2F;weave-scope-agent-ws-chksk                     1&#x2F;1     Running     0          117m</span><br><span class="line">pod&#x2F;weave-scope-cluster-agent-ws-99cdb686f-lhg47   1&#x2F;1     Running     0          117m</span><br><span class="line">pod&#x2F;weave-scope-frontend-ws-7c5f4947c-9ggl7        1&#x2F;1     Running     0          117m</span><br><span class="line">pod&#x2F;web2-deploy-6799fc88d8-588h5                   1&#x2F;1     Running     0          6m2s</span><br><span class="line"></span><br><span class="line">NAME                     TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">service&#x2F;kubernetes       ClusterIP   10.10.0.1      &lt;none&gt;        443&#x2F;TCP        6d6h</span><br><span class="line">service&#x2F;web2-svc         NodePort    10.10.73.67    &lt;none&gt;        80:32033&#x2F;TCP   6m2s</span><br><span class="line">service&#x2F;ws-weave-scope   NodePort    10.10.54.125   &lt;none&gt;        80:31445&#x2F;TCP   117m</span><br></pre></td></tr></table></figure>




<h1 id="持久化存储"><a href="#持久化存储" class="headerlink" title="持久化存储"></a>持久化存储</h1><h2 id="nfs：网络存储"><a href="#nfs：网络存储" class="headerlink" title="nfs：网络存储"></a>nfs：网络存储</h2><ol>
<li><p>在一台服务器安装nfs</p>
<p><code>yum install -y nfs-utils</code></p>
<p>设置挂载路径</p>
<p><code>vi /etc/exports</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;data&#x2F;nfs *(rw,no_root_squash)</span><br></pre></td></tr></table></figure>

<p><code>mkdir -p /data/nfs</code></p>
</li>
<li><p>在k8s node节点安装nfs</p>
<p><code>yum install -y nfs-utils</code></p>
</li>
<li><p>在nfs服务器启动nfs服务</p>
<p><code>systemctl start nfs</code></p>
</li>
<li><p>在k8s集群部署应用，使用nfs持久化存储</p>
<p><code>vi nfs-nginx.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-dep1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wwwroot</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wwwroot</span></span><br><span class="line">        <span class="attr">nfs:</span></span><br><span class="line">          <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.201</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/data/nfs</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>kubectl apply -f nfs-nginx.yaml</code></p>
</li>
<li><p>测试</p>
<p>在nfs服务器中添加内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /data/nfs</span><br><span class="line">vi index.html</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello nfs</span><br></pre></td></tr></table></figure>

<p>在pod中查看</p>
<p><code>kubectl exec -it nginx-dep1-6d599f4489-8vttg bash</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@cluster1 k8s-learn]# kubectl exec -it nginx-dep1-6d599f4489-8vttg bash</span><br><span class="line"></span><br><span class="line">root@nginx-dep1-6d599f4489-8vttg:&#x2F;# ls &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;</span><br><span class="line">index.html</span><br></pre></td></tr></table></figure>

<p>暴露端口</p>
<p><code>kubectl expose deployment nginx-dep1 --port=80 --target-port=80 --type=NodePort</code></p>
<p><code>curl localhost:</code></p>
</li>
</ol>
<h2 id="pv与pvc"><a href="#pv与pvc" class="headerlink" title="pv与pvc"></a>pv与pvc</h2><p>PV：持久化存储，对存储的资源进行抽象，对外提供可以调用的地方【生产者】</p>
<p>PVC：用于调用，不需要关心内部实现细节【消费者】</p>
<p>示例：</p>
<ol>
<li><p>创建一个deployment和pvc</p>
<p><code>vi pvc.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-dep1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wwwroot</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wwwroot</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">my-pvc</span></span><br><span class="line">          </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">5Gi</span></span><br></pre></td></tr></table></figure>

<p><code>kubectl apply -f pvc.yaml</code></p>
<p>创建pv</p>
<p><code>vi pv.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/nfs</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.201</span></span><br></pre></td></tr></table></figure>

<p>进入容器查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@cluster1 k8s-learn]# kubectl exec -it nginx-dep1-69f5bb95b-8rx8m bash</span><br><span class="line">kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.</span><br><span class="line">root@nginx-dep1-69f5bb95b-8rx8m:&#x2F;# ls &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html</span><br><span class="line">index.html</span><br><span class="line">root@nginx-dep1-69f5bb95b-8rx8m:&#x2F;# cat &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html   </span><br><span class="line">hello nfs</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h1 id="集群资源监控"><a href="#集群资源监控" class="headerlink" title="集群资源监控"></a>集群资源监控</h1><ul>
<li>集群监控<ul>
<li>节点资源利用率</li>
<li>节点数</li>
<li>运行Pods</li>
</ul>
</li>
<li>Pod监控<ul>
<li>容器指标</li>
<li>应用程【程序占用多少CPU、内存】</li>
</ul>
</li>
</ul>
<h2 id="安装kubesphere"><a href="#安装kubesphere" class="headerlink" title="安装kubesphere"></a>安装kubesphere</h2><h2 id="安装dashboard"><a href="#安装dashboard" class="headerlink" title="安装dashboard"></a>安装dashboard</h2><p>下载dashboard配置文件</p>
<p><code>wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.1.0/aio/deploy/recommended.yaml</code></p>
<p>修改文件，添加NodePort访问方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort #add</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">      nodeport: 30001  #add</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br></pre></td></tr></table></figure>

<p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@cluster1 k8s-dashboard]# kubectl apply -f recommended.yaml </span><br><span class="line">namespace&#x2F;kubernetes-dashboard unchanged</span><br><span class="line">serviceaccount&#x2F;kubernetes-dashboard unchanged</span><br><span class="line">service&#x2F;kubernetes-dashboard created</span><br><span class="line">secret&#x2F;kubernetes-dashboard-certs created</span><br><span class="line">secret&#x2F;kubernetes-dashboard-csrf created</span><br><span class="line">secret&#x2F;kubernetes-dashboard-key-holder created</span><br><span class="line">configmap&#x2F;kubernetes-dashboard-settings created</span><br><span class="line">role.rbac.authorization.k8s.io&#x2F;kubernetes-dashboard created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io&#x2F;kubernetes-dashboard created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io&#x2F;kubernetes-dashboard created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io&#x2F;kubernetes-dashboard created</span><br><span class="line">deployment.apps&#x2F;kubernetes-dashboard created</span><br><span class="line">service&#x2F;dashboard-metrics-scraper created</span><br><span class="line">deployment.apps&#x2F;dashboard-metrics-scraper created</span><br></pre></td></tr></table></figure>

<p>创建service account并绑定默认cluster-admin管理员角色</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount dashboard-admin -n kube-system</span><br><span class="line">kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span><br></pre></td></tr></table></figure>

<p>获取token</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk &#39;&#x2F;dashboard-admin&#x2F;&#123;print $1&#125;&#39;)</span><br></pre></td></tr></table></figure>

<p>访问<code>30001</code>端口(注意https)，输入token进入dashboard页面</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/12/19/Hexo%E4%B8%BB%E9%A2%98%E6%9B%B4%E6%8D%A2%E2%80%94%E2%80%94Next%E4%B8%BB%E9%A2%98/" rel="prev" title="Hexo主题安装——Next主题">
                  <i class="fa fa-chevron-left"></i> Hexo主题安装——Next主题
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/01/26/MySQL%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" rel="next" title="MySQL集群搭建">
                  MySQL集群搭建 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Doge Rice</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
